# It is a good practice to update your EC2 instance with the latest security updates
sudo apt update -y
sudo apt upgrade -y
# Command to install HAProxy
sudo apt install -y haproxy

# Command to configure HAProxy
sudo nano /etc/haproxy/haproxy.cfg

# At the end of the file, add these lines:
# Remember to change the [PRIVATE_IP_ADDRESS_OF_YOUR_OWNCAST_EC2_INSTANCE] tag with the private IP address of your Owncast EC2 instance
# If you want to use HTTPS (443) port and a sub domain name, remember to change the [YOUR_PEM_FILE_NAME] tag with the PEM file name you created with Let's Encrypt

# ========== GLOBAL & DEFAULTS ==========
global
    log stdout format raw local0
    tune.ssl.default-dh-param 2048

defaults
    mode    http
    timeout connect 5s
    timeout client  50s
    timeout server  5m

# ========== RTMPS PROXY TO 1935 ==========
frontend rtmps_front
    # Bind the RTMPS (1935) port only if you want to use a certificate
    # If you don't need a certificate and don't need to use the RTMPS (1935) port, you can change to bind *:1935, but remember to change the Security Group
    bind *:1935 ssl crt /etc/haproxy/certs/[YOUR_PEM_FILE_NAME].pem
    mode tcp
    default_backend rtmp_back

backend rtmp_back
    mode tcp
    option tcp-check
    tcp-check connect port 1935
    server owncast_rtmp [PRIVATE_IP_ADDRESS_OF_YOUR_OWNCAST_EC2_INSTANCE]:1935 check

# ========== HTTPS PROXY TO 8080 ==========
frontend https_front
    # Bind the HTTPS (443) port only if you want to use a certificate
    # If you don't need a certificate and don't need to use the HTTPS (443) port, you can change to bind *:8080, but remember to change the Security Group
    bind *:443 ssl crt /etc/haproxy/certs/[YOUR_PEM_FILE_NAME].pem

    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto https

    acl blocked_path path_beg /hls
    http-request deny if blocked_path

    default_backend http_back

backend http_back
    mode http
    server owncast_http [PRIVATE_IP_ADDRESS_OF_YOUR_OWNCAST_EC2_INSTANCE]:8080 check

# When using nano, to write the changes you made to the file, press [CTRL] + [O], to exit press [CTRL] + [X]

sudo systemctl enable haproxy
sudo systemctl restart haproxy